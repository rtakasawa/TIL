# バックアップとリストア
- リストアとは：復元する、修復する等の意味

## psql稼働中のバックアップ、リストア
### pg_dumpコマンド,pg_dumpallコマンドによるバックアップ
- pg_dumpコマンド\
  データベースを指定してバックアップを取る場合に使用する
- pg_dumpallコマンド \
  すべてのデータベース、データベースクラスターのバックアップを取る場合に使用する
- デフォルトで平文でSQLの羅列がバックアップとして出力される。
- ファイル形式で出力する場合のファイルの保存先はコマンド実行時のカレントディレクトリ内に保存される

### 平文形式のリストア
- psql 接続オプション -f ファイル名

### 平文形式以外のリストア
- pg_restore 接続オプション オプション -d データベース名 ファイル名
- -dオプションでリストア先のデータベースを指定する

## ディレクトリコピーによるバックアップ、リストア
- サーバーが停止中にディレクトリをバックアップ、リストアする

## PITR(point in time recovery)
### 概要
- ある時点のデータベース全体のバックアップを取得する⇛ベースバックアップ
- psqlにはデータベースに対して行われた変更を記録する機構が備わっており、内容はログに出力される。⇛先行書き込みログまたはWALという。
- WALは溜まっていくと古いWALは捨てられるが、PITRの際には古いWALは削除せず別の場所に保存する。

### 前準備・設定
- archive_modeをonにして、WALを保存する場所を指定する

### ベースバックアップ
- psqlを停止する必要なし
- スーパーユーザーで稼働中のpsqlに接続して、pg_start_backup関数を呼び出した後、データクラスターのディレクトリをまるごとバックアップして、pg_stop_back関数を呼び出す。


